<!-- support_admin.html - Complete version with UTC+8 timezone support -->
{# Admin: Support Tickets with Consistent Timezone Display #}
{% extends "admin/base.html" %}

{% block content %}
<div class="container-fluid">
  <div class="mb-4 d-flex justify-content-between align-items-center">
    <h3 class="mb-0">Support Tickets</h3>
    <div class="d-flex align-items-center" style="gap: 1rem;">
      <a href="/support/admin/broadcast" class="btn btn-warning">
        <i class="fas fa-bullhorn mr-1"></i>Broadcast
      </a>
      <div class="d-flex align-items-center" style="gap:.5rem">
        <label class="text-muted mb-0 small">Translate target</label>
        <select id="sc-target" class="form-control form-control-sm" style="width:auto">
          <option value="en" selected>English (en)</option>
          <option value="ms">Malay (ms)</option>
          <option value="id">Indonesian (id)</option>
          <option value="th">Thai (th)</option>
          <option value="km">Khmer (km)</option>
          <option value="lo">Lao (lo)</option>
          <option value="my">Burmese (my)</option>
          <option value="vi">Vietnamese (vi)</option>
        </select>
      </div>
    </div>
  </div>

  <div class="row">
    {# ===================== TICKETS LIST ===================== #}
    <div class="col-lg-4">
      <div class="card" id="sc-admin-list" style="height: calc(100vh - 200px);">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-ticket-alt mr-2"></i>All Tickets</h5>
        </div>
        <div class="card-body p-0" style="overflow-y: auto;">
          {% for t in tickets %}
          <div class="border-bottom p-3 ticket-item" style="cursor: pointer; transition: background-color 0.2s; position: relative;" 
               data-open-ticket="{{ t.id }}"
               data-updated="{{ t.updated.isoformat() if t.updated else '' }}"
               onmouseover="this.style.backgroundColor='#f8f9fa'" 
               onmouseout="this.style.backgroundColor='white'">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-1">
                  <strong class="text-primary">#{{ t.id }}</strong>
                  <span class="ml-2 badge badge-{{ 'success' if t.status == 'open' else 'secondary' }}">
                    {{ t.status }}
                  </span>
                  {# Notification badge for unread user messages #}
                  {% if t.unread_user_messages and t.unread_user_messages > 0 %}
                  <span class="ml-2 badge badge-danger badge-pill notification-badge">
                    {{ t.unread_user_messages if t.unread_user_messages <= 99 else '99+' }}
                  </span>
                  {% endif %}
                </div>
                <div class="text-muted small mb-1">
                  {% if t.user %}
                    <i class="fas fa-user mr-1"></i>{{ t.user.name|truncate(15) }}
                    {% if t.user.team %}
                      <div class="text-info small" style="margin-left: 16px;">
                        <i class="fas fa-users mr-1"></i>Team {{ t.user.team.name|truncate(12) }}
                      </div>
                    {% endif %}
                  {% else %}
                    <i class="fas fa-user-times mr-1 text-warning"></i>
                    <span class="text-warning">deleted user</span>
                  {% endif %}
                </div>
                <div class="text-muted small">
                  <i class="fas fa-clock mr-1"></i>
                  {# Server will provide UTC+8 converted timestamps #}
                  <span class="format-date">
                    {% if t.updated %}
                      {{ t.updated.isoformat() }}
                    {% else %}
                      N/A
                    {% endif %}
                  </span>
                </div>
              </div>
              <button class="btn btn-outline-primary btn-sm" data-open-ticket="{{ t.id }}">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          {% else %}
          <div class="text-center text-muted py-5">
            <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
            <p>No tickets yet.</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    {# ===================== TICKET DETAIL ===================== #}
    <div class="col-lg-8">
      <div class="card" id="sc-admin-detail" style="height: calc(100vh - 200px); display: flex; flex-direction: column;">
        <div class="card-body d-flex align-items-center justify-content-center text-muted" style="flex: 1;">
          <div class="text-center">
            <i class="fas fa-comments fa-4x mb-3 text-muted"></i>
            <h5>Select a ticket to view conversation</h5>
            <p class="text-muted">Click on any ticket from the left panel to start managing it.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Admin panel styles */
#sc-admin-detail .ticket-header {
  background: linear-gradient(135deg, #007bff, #0056b3);
  color: white;
  padding: 1rem;
  border-radius: 0.375rem 0.375rem 0 0;
}

#sc-admin-detail .ticket-messages {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  background-color: #f8f9fa;
}

#sc-admin-detail .message-bubble {
  max-width: 80%;
  margin-bottom: 1rem;
  padding: 0.75rem 1rem;
  border-radius: 1rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

#sc-admin-detail .message-user {
  background-color: #e3f2fd;
  margin-left: auto;
  text-align: right;
}

#sc-admin-detail .message-admin {
  background-color: white;
  margin-right: auto;
}

#sc-admin-detail .message-meta {
  font-size: 0.75rem;
  opacity: 0.7;
  margin-bottom: 0.25rem;
}

#sc-admin-detail .reply-section {
  border-top: 1px solid #dee2e6;
  padding: 1rem;
  background: white;
}

#sc-admin-detail .ticket-closed {
  background-color: #f8d7da;
  color: #721c24;
  text-align: center;
  padding: 1rem;
  border-top: 1px solid #f5c6cb;
}

.ticket-item:hover {
  background-color: #f8f9fa !important;
}

.translate-link {
  font-size: 0.75rem;
  color: #007bff;
  text-decoration: underline;
  cursor: pointer;
}

.translate-link:hover {
  color: #0056b3;
}

.ticket-item .text-info {
  font-weight: 500;
}

#sc-admin-detail .user-info-with-team {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.5rem;
}

#sc-admin-detail .team-badge {
  background-color: rgba(255, 255, 255, 0.2);
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
}

#sc-admin-detail .btn-danger {
  background-color: #dc3545;
  border-color: #dc3545;
}

#sc-admin-detail .btn-danger:hover {
  background-color: #c82333;
  border-color: #bd2130;
}

#sc-admin-detail .btn-danger:disabled {
  background-color: #6c757d;
  border-color: #6c757d;
}

#sc-admin-detail .ticket-header .d-flex[style*="gap"] > * {
  margin-left: 0;
}

.text-warning {
  color: #856404 !important;
}

.fa-user-times {
  color: #dc3545 !important;
}

.btn-warning {
  background-color: #ffc107;
  border-color: #ffc107;
  color: #212529;
}

.btn-warning:hover {
  background-color: #e0a800;
  border-color: #d39e00;
  color: #212529;
}

.mb-4 .d-flex[style*="gap"] > * {
  margin-left: 0;
}

.notification-badge {
  font-size: 0.65rem;
  font-weight: bold;
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(1.05); }
  100% { opacity: 1; transform: scale(1); }
}

.notification-badge.seen {
  animation: none;
}

/* Responsive design */
@media (max-width: 768px) {
  .mb-4 .d-flex {
    flex-direction: column;
    gap: 0.5rem !important;
  }
  
  .col-lg-4, .col-lg-8 {
    padding-left: 0.5rem;
    padding-right: 0.5rem;
  }
  
  #sc-admin-list, #sc-admin-detail {
    height: calc(50vh - 100px) !important;
  }
}
</style>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script defer src="/plugins/support_chat/assets/admin.js"></script>
  
  {# Updated script for UTC+8 timezone formatting #}
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // UTC+8 date formatting function - handles server-converted timestamps
    function formatDate(dateStr) {
      if (!dateStr || dateStr === 'N/A') return 'N/A';
      try {
        // Server already sends UTC+8 converted timestamps, so just parse and format
        const date = new Date(dateStr);
        
        // Format as MM/DD HH:MM
        return String(date.getMonth() + 1).padStart(2, '0') + '/' + 
               String(date.getDate()).padStart(2, '0') + ' ' +
               String(date.getHours()).padStart(2, '0') + ':' +
               String(date.getMinutes()).padStart(2, '0');
      } catch (e) {
        console.error('Date formatting error:', e);
        return 'Invalid Date';
      }
    }
    
    // Format all dates on the page with consistent UTC+8 formatting
    document.querySelectorAll('.format-date').forEach(function(element) {
      const dateStr = element.textContent.trim();
      element.textContent = formatDate(dateStr);
    });

    // Add timezone indicator for clarity
    const timeElements = document.querySelectorAll('.format-date');
    if (timeElements.length > 0) {
      // Add a small indicator showing the timezone being used
      const timezoneIndicator = document.createElement('small');
      timezoneIndicator.textContent = ' (UTC+8)';
      timezoneIndicator.className = 'text-muted';
      timezoneIndicator.style.fontSize = '0.65rem';
      
      // Add to the first clock icon's parent for reference
      const firstClockIcon = document.querySelector('.fa-clock');
      if (firstClockIcon) {
        firstClockIcon.parentElement.appendChild(timezoneIndicator);
      }
    }
  });
  </script>
{% endblock %}